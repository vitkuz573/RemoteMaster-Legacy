@page "/{ipAddress}/screen"

@using Microsoft.AspNetCore.SignalR.Client
@using RemoteMaster.Client.Models

@inject NavigationManager NavigationManager

@code {
    [Parameter]
    public string IPAddress { get; set; }

    private HubConnection hubConnection;
    private string serverUrl;
    private string connectionError;

    protected override async Task OnInitializedAsync()
    {
        serverUrl = $"https://{IPAddress}:7172/screenHub?ipAddress={IPAddress}";
        hubConnection = new HubConnectionBuilder()
            .WithUrl(serverUrl, options =>
            {
                options.HttpMessageHandlerFactory = _ => new HttpClientHandler
                    {
                        ServerCertificateCustomValidationCallback = HttpClientHandler.DangerousAcceptAnyServerCertificateValidator
                    };
            })
            .Build();

        hubConnection.On<byte[]>("ScreenUpdate", HandleScreenUpdate);

        try
        {
            await hubConnection.StartAsync();
        }
        catch (Exception ex)
        {
            connectionError = $"Error starting connection: {ex.Message}";
        }
    }

    private void HandleScreenUpdate(byte[] screenData)
    {
        // Обработка обновления экрана, полученного от сервера
    }

    public void Dispose()
    {
        hubConnection?.DisposeAsync();
    }
}

@if (!string.IsNullOrEmpty(connectionError))
{
    <p>@connectionError</p>
}
else
{
    <p>Connection started successfully.</p>
}

@page "/"
@using Microsoft.AspNetCore.Components.Web
@namespace RemoteMaster.Client.Pages
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="~/" />
    <link href="css/site.css" rel="stylesheet" />
    <link href="RemoteMaster.Client.styles.css" rel="stylesheet" />

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&amp;display=swap" rel="stylesheet">

    <link href="css/compiled.css" rel="stylesheet" />

    <link rel="stylesheet" href="_content/Radzen.Blazor/css/standard-base.css">
    <link rel="icon" type="image/png" href="favicon.png"/>
    <component type="typeof(HeadOutlet)" render-mode="ServerPrerendered" />
</head>
<body>
    <component type="typeof(App)" render-mode="ServerPrerendered" />

    <div id="blazor-error-ui">
        <environment include="Staging,Production">
            An error has occurred. This application may no longer respond until reloaded.
        </environment>
        <environment include="Development">
            An unhandled exception has occurred. See browser dev tools for details.
        </environment>
        <a href="" class="reload">Reload</a>
        <a class="dismiss">🗙</a>
    </div>

    <script src="_framework/blazor.server.js"></script>

    <script src="_content/Radzen.Blazor/Radzen.Blazor.js"></script>

    <script type="module">
        import DragSelect from 'https://unpkg.com/dragselect@latest/dist/ds.es6m.min.js'

        window.revokeUrl = function (url) {
            URL.revokeObjectURL(url);
        }

        window.createImageBlobUrl = function (data) {
            const blob = new Blob([data], { type: 'image/jpeg' });
            return URL.createObjectURL(blob);
        }

        window.addKeyDownEventListener = (dotnetHelper) => {
            window.onkeydown = (e) => {
                dotnetHelper.invokeMethodAsync('OnKeyDown', e.keyCode);
            };
        };

        window.addKeyUpEventListener = (dotnetHelper) => {
            window.onkeyup = (e) => {
                dotnetHelper.invokeMethodAsync('OnKeyUp', e.keyCode);
            };
        };

        window.disableContextMenuOnImage = () => {
            document.getElementById('screenImage').addEventListener('contextmenu', (event) => {
                event.preventDefault();
            });
        };

        window.setTitle = (title) => {
            document.title = title;
        }

        window.selectedIPs = [];
        
        document.addEventListener('DOMContentLoaded', (event) => {
            const ds = new DragSelect({
                selectables: document.getElementsByClassName('selectable-node'),
                area: document.querySelector('#container'),
                draggability: false
            });
        
            ds.subscribe('callback', (e) => {
                var selectedItems = e.items;
                var ipAddresses = Array.from(selectedItems).map(item => item.getAttribute('data-ip-address'));
        
                // сохраняем выбранные IP в глобальную переменную
                window.selectedIPs = ipAddresses;

                console.log(ipAddresses);
            });
        });
        
        window.openTabs = () => {
            let blockedPopups = false;
            window.selectedIPs.forEach(ipAddress => {
                var url = `http://localhost:5254/${ipAddress}/control`;
                const popupWindow = window.open(url, '_blank');
                if (!popupWindow || popupWindow.closed || typeof popupWindow.closed === 'undefined') {
                    blockedPopups = true;
                }
            });
        
            if (blockedPopups) {
                const confirmationMessage = `Всплывающие окна были заблокированы. Пожалуйста, разрешите их для сайта и повторите попытку.`;
                alert(confirmationMessage);
            }
        };

        window.toggleSelection = function (ipAddress) {
            const elements = document.querySelectorAll(`.selectable-node[data-ip-address="${ipAddress}"]`);
            elements.forEach(element => {
                element.classList.add('ds-selected');
                if (!window.selectedIPs.includes(ipAddress)) {
                    window.selectedIPs.push(ipAddress);
                }
            });
        };
    </script>
</body>
</html>

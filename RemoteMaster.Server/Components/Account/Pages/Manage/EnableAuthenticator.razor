@page "/Account/Manage/EnableAuthenticator"

@using Microsoft.AspNetCore.Identity
@using System.Text.Encodings.Web
@using RemoteMaster.Server.Data

@inject UserManager<ApplicationUser> UserManager
@inject IdentityUserAccessor UserAccessor
@inject UrlEncoder UrlEncoder
@inject IdentityRedirectManager RedirectManager

<PageTitle>Configure authenticator app</PageTitle>

@if (recoveryCodes is not null)
{
    <ShowRecoveryCodes RecoveryCodes="recoveryCodes.ToArray()" StatusMessage="@message" />
}
else
{
    <StatusMessage Message="@message" />
    <h3 class="mb-4 text-xl font-semibold text-gray-800">Configure authenticator app</h3>
    <div class="space-y-4 text-gray-700">
        <p>To use an authenticator app, go through the following steps:</p>
        <ol class="list-decimal space-y-2">
            <li>
                <p>Download a two-factor authenticator app like Microsoft Authenticator for Android and iOS, or Google Authenticator for Android and iOS.</p>
            </li>
            <li>
                <p>Scan the QR Code or enter this key into your two-factor authenticator app. Spaces and casing do not matter:</p>
                <div class="flex flex-col items-center space-y-3">
                    @if (authenticatorUri != null)
                    {
                        <div id="qrCode"></div>
                        <input type="hidden" id="qrCodeData" data-url="@authenticatorUri" />
                    }
                    <kbd class="rounded bg-gray-200 px-2 py-1 font-mono text-sm">@sharedKey</kbd>
                </div>
            </li>
            <li>
                <p>Once you have scanned the QR code or input the key above, your two-factor authentication app will provide you with a unique code. Enter the code in the confirmation box below.</p>
                <div class="mt-4">
                    <EditForm Model="Input" FormName="send-code" OnValidSubmit="OnValidSubmitAsync" method="post">
                        <div class="mb-4">
                            <InputText @bind-Value="Input.Code" class="form-input w-full rounded-md border border-gray-300 px-4 py-2 focus:ring-blue-500 focus:border-blue-500" autocomplete="off" placeholder="Verification Code" />
                            <ValidationMessage For="() => Input.Code" class="text-red-500 mt-2" />
                        </div>
                        <button type="submit" class="w-full rounded-md bg-blue-600 px-4 py-2 text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50">Verify</button>
                        <ValidationSummary class="mt-2 text-red-500" />
                    </EditForm>
                </div>
            </li>
        </ol>
        <div class="text-sm">
            <a href="https://go.microsoft.com/fwlink/?Linkid=852423" class="text-blue-600 underline hover:text-blue-700">Learn how to enable QR code generation.</a>
        </div>
    </div>
}

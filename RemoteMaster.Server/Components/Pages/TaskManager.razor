@page "/{Host}/taskmanager"

@rendermode InteractiveServer

@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using RemoteMaster.Server.Abstractions
@using RemoteMaster.Server.Data
@using RemoteMaster.Shared.Models

@inject IJSRuntime JsRuntime
@inject IAccessTokenProvider AccessTokenProvider
@inject UserManager<ApplicationUser> UserManager
@inject IHttpContextAccessor HttpContextAccessor

<div class="min-h-screen bg-gray-100 p-6">
    <div class="mx-auto max-w-7xl">
        <div class="mb-4 flex items-center justify-between">
            <h2 class="text-2xl font-bold text-gray-900">Task Manager</h2>
            <div class="flex space-x-4">
                <input @bind="_processPath" placeholder="Enter process path" class="mt-1 block rounded-md border border-gray-300 bg-white px-3 py-2 shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" />
                <button @onclick="StartProcess" class="rounded-md bg-indigo-600 px-4 py-2 text-white hover:bg-indigo-700 focus:outline-none">
                    Start Process
                </button>
                <input @bind="_searchQuery" placeholder="Search" class="mt-1 block rounded-md border border-gray-300 bg-white px-3 py-2 shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500" />
            </div>
        </div>

        <table class="min-w-full overflow-hidden rounded-md bg-white shadow">
            <thead>
                <tr class="bg-gray-50">
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                        Process ID
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                        Name
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                        Memory Usage
                    </th>
                    <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-500">
                        Actions
                    </th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-200 bg-white">
                @foreach (var process in _processes)
                {
                    <tr>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-900">@process.Id</td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-900">
                            <div class="flex items-center">
                                @if (process.Icon != null)
                                {
                                    <img src="@($"data:image/png;base64,{Convert.ToBase64String(process.Icon)}")" alt="Icon" class="mr-2 h-5 w-5" />
                                }
                                <span>@process.Name</span>
                            </div>
                        </td>
                        <td class="whitespace-nowrap px-6 py-4 text-sm text-gray-900">@FormatSize(process.MemoryUsage)</td>
                        <td class="whitespace-nowrap px-6 py-4 text-right text-sm font-medium">
                            <button @onclick="() => KillProcess(process.Id)" class="rounded-md bg-red-600 px-4 py-2 text-white hover:bg-red-700 focus:outline-none">
                                Kill
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>
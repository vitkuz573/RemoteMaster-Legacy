@page "/"

@rendermode InteractiveServer

@attribute [Authorize]

@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.Extensions.Localization
@using RemoteMaster.Server.Abstractions
@using RemoteMaster.Server.Data
@using RemoteMaster.Server.Models
@using RemoteMaster.Shared.Abstractions
@using RemoteMaster.Shared.Models
@using System.Security.Claims

@inject IBrandingService BrandingService
@inject IDialogService DialogService
@inject IDatabaseService DatabaseService
@inject ICrlService CrlService
@inject ISnackbar Snackbar
@inject IJSRuntime JsRuntime
@inject NavigationManager NavigationManager
@inject IAccessTokenProvider AccessTokenProvider
@inject UserManager<ApplicationUser> UserManager
@inject IStringLocalizer<Home> Localizer

<PageTitle>@Localizer["PageTitle"]</PageTitle>

<MudLayout>
    <MudAppBar Elevation="0" Color="Color.Primary">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
        <MudSpacer />
        <AuthorizeView>
            <Authorized>
                <MudText>@context.User.Identity.Name (@context.User.Claims.FirstOrDefault(c => c.Type == ClaimTypes.Role)?.Value)</MudText>
            </Authorized>
        </AuthorizeView>
    </MudAppBar>
    <MudDrawer @bind-Open="@DrawerOpen" Variant="@DrawerVariant.Responsive" Elevation="0">
        <MudDrawerHeader>
            <MudText Typo="Typo.h6">
                <img src="@BrandingService.ApplicationLogo" width="@BrandingService.ApplicationLogoWidth" height="@BrandingService.ApplicationLogoHeight" alt="@BrandingService.ApplicationName" />
            </MudText>
        </MudDrawerHeader>
        <MudNavMenu>
            <AuthorizeView>
                <Authorized>
                    @if (context.User.IsInRole("Administrator"))
                    {
                        <MudNavLink Match="NavLinkMatch.All" OnClick="OpenHostConfig">@Localizer["MenuHostConfig"]</MudNavLink>
                        <MudNavLink Match="NavLinkMatch.All" OnClick="PublishCrl">@Localizer["MenuPublishCrl"]</MudNavLink>
                    }
                    <MudNavLink Match="NavLinkMatch.All" OnClick="ManageProfile">@Localizer["MenuProfile"]</MudNavLink>
                    <MudNavLink Match="NavLinkMatch.All" OnClick="Logout">@Localizer["MenuLogout"]</MudNavLink>
                </Authorized>
            </AuthorizeView>
        </MudNavMenu>
    </MudDrawer>

    <MudMainContent>
        <div class="flex h-full">
            <div class="w-1/5">
                <MudTreeView Items="@_treeItems" T="INode" SelectedValueChanged="OnNodeSelected" Hover="true" Class="pa-6">
                    <ItemTemplate>
                        <MudTreeViewItem Text="@context.Text" Value="@context.Value" Icon="@context.Icon">
                            <ChildContent>
                                @if (context.Children != null && context.Children.Count > 0)
                                {
                                    @foreach (var child in context.Children)
                                    {
                                        <MudTreeViewItem Text="@child.Text" Value="@child.Value" Icon="@child.Icon" />
                                    }
                                }
                            </ChildContent>
                        </MudTreeViewItem>
                    </ItemTemplate>
                </MudTreeView>
            </div>

            <div class="flex flex-grow flex-col gap-4 p-4">
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-6 tabs flex">
                    <MudTabPanel Text="@Localizer["MainTab"]" Icon="@Icons.Material.Filled.Api">
                        <AuthorizeView>
                            <Authorized>
                                @if (context.User.IsInRole("Administrator"))
                                {
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Power" Disabled="@(_selectedComputers.Count == 0 || !_selectedComputers.All(c => _availableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">@Localizer["Power"]</MudButton>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="WakeUp" Disabled="@(_selectedComputers.Count == 0)" Class="mr-2">@Localizer["WakeUp"]</MudButton>
                                }
                                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Connect" Disabled="@(_selectedComputers.Count == 0 || !_selectedComputers.All(c => _availableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">@Localizer["Connect"]</MudButton>
                                @if (context.User.IsInRole("Administrator"))
                                {
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Lock" Disabled="@(_selectedComputers.Count == 0 || !_selectedComputers.All(c => _availableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">Lock</MudButton>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="OpenShell" Disabled="@(_selectedComputers.Count == 0)" Class="mr-2">@Localizer["OpenShell"]</MudButton>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="ExecuteScript" Disabled="@(_selectedComputers.Count == 0 || !_selectedComputers.All(c => _availableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">@Localizer["ExecuteScript"]</MudButton>
                                }
                                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="LogonComputers" Disabled="@(_selectedComputers.Count == 0 || _selectedComputers.Any(c => _availableComputers.ContainsKey(c.IpAddress) || _unavailableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">@Localizer["Logon"]</MudButton>
                                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="LogoffComputers" Disabled="@(_selectedComputers.Count == 0 || !_selectedComputers.Any(c => _availableComputers.ContainsKey(c.IpAddress) || _unavailableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">@Localizer["Logoff"]</MudButton>
                                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Refresh" Class="ml-auto">Refresh</MudButton>
                            </Authorized>
                        </AuthorizeView>
                    </MudTabPanel>

                    <AuthorizeView>
                        <Authorized>
                            @if (context.User.IsInRole("Administrator"))
                            {
                                <MudTabPanel Text="@Localizer["ServiceTab"]" Icon="@Icons.Material.Filled.Key">
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="SetMonitorState" Disabled="@(_selectedComputers.Count == 0 || !_selectedComputers.All(c => _availableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">@Localizer["SetMonitorState"]</MudButton>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="ManagePsExecRules" Disabled="@(_selectedComputers.Count == 0 || !_selectedComputers.All(c => _availableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">@Localizer["PSExecRules"]</MudButton>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="ScreenRecorder" Disabled="@(_selectedComputers.Count == 0 || !_selectedComputers.All(c => _availableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">@Localizer["ScreenRecorder"]</MudButton>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="DomainMembership" Disabled="@(_selectedComputers.Count == 0 || !_selectedComputers.All(c => _availableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">@Localizer["DomainMembership"]</MudButton>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="Update" Disabled="@(_selectedComputers.Count == 0 || !_selectedComputers.All(c => _availableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">@Localizer["Update"]</MudButton>
                                </MudTabPanel>

                                <MudTabPanel Text="@Localizer["ToolsTab"]" Icon="@Icons.Material.Filled.MiscellaneousServices">
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="OpenTaskManager" Disabled="@(_selectedComputers.Count == 0 || !_selectedComputers.All(c => _availableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">@Localizer["TaskManager"]</MudButton>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="OpenFileManager" Disabled="@(_selectedComputers.Count == 0 || !_selectedComputers.All(c => _availableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">@Localizer["FileManager"]</MudButton>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="FileUpload" Disabled="@(_selectedComputers.Count == 0 || !_selectedComputers.All(c => _availableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">@Localizer["UploadFile"]</MudButton>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="MessageBox" Disabled="@(_selectedComputers.Count == 0 || !_selectedComputers.All(c => _availableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">@Localizer["MessageBox"]</MudButton>
                                </MudTabPanel>

                                <MudTabPanel Text="@Localizer["ManagementTab"]" Icon="@Icons.Material.Filled.Settings">
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="OpenHostInfo" Disabled="@(_selectedComputers.Count != 1)" Class="mr-2">@Localizer["HostInfo"]</MudButton>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="OpenMoveDialog" Disabled="@(_selectedComputers.Count == 0)" Class="mr-2">@Localizer["MoveHost"]</MudButton>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="RemoveComputers" Disabled="@(_selectedComputers.Count == 0)" Class="mr-2">@Localizer["Remove"]</MudButton>
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="RenewCertificate" Disabled="@(_selectedComputers.Count == 0 || !_selectedComputers.All(c => _availableComputers.ContainsKey(c.IpAddress)))" Class="mr-2">@Localizer["RenewCertificate"]</MudButton>
                                </MudTabPanel>

                                <MudTabPanel Text="@Localizer["ExtraTab"]" Icon="@Icons.Material.Filled.Settings">
                                    <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="RemoteExecutor" Class="mr-2">@Localizer["RemoteExecutor"]</MudButton>
                                </MudTabPanel>
                            }
                        </Authorized>
                    </AuthorizeView>
                </MudTabs>

                <div class="flex flex-col gap-4">
                    <MudExpansionPanels MultiExpansion="true">
                        <MudExpansionPanel Text="@(Localizer["AvailableComputers"] + " (" + _availableComputers.Count + ")")" Expanded="true">
                            <MudButton Color="Color.Primary" Variant="Variant.Outlined" OnClick="SelectAllAvailableComputers" Disabled="@(!CanSelectAll(_availableComputers))">@Localizer["SelectAll"]</MudButton>
                            <MudButton Color="Color.Primary" Variant="Variant.Outlined" OnClick="DeselectAllAvailableComputers" Disabled="@(!CanDeselectAll(_availableComputers))">@Localizer["DeselectAll"]</MudButton>
                            <div class="mt-4 flex flex-wrap gap-4">
                                @if (_availableComputers.Any())
                                {
                                    @foreach (var computer in GetSortedComputers(_availableComputers))
                                    {
                                        <div class="w-1/6">
                                            <ComputerCard @key="computer" Computer="computer" IsSelectedChanged="@(isSelected => SelectComputer(computer, isSelected))" IsSelected="_selectedComputers.Contains(computer)" />
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="w-full p-4 text-center">
                                        <MudText Typo="Typo.body1">@Localizer["NoAvailableComputers"]</MudText>
                                    </div>
                                }
                            </div>
                        </MudExpansionPanel>
                        <MudExpansionPanel Text="@(Localizer["UnavailableComputers"] + " (" + _unavailableComputers.Count + ")")" Expanded="true">
                            <MudButton Color="Color.Primary" Variant="Variant.Outlined" OnClick="SelectAllUnavailableComputers" Disabled="@(!CanSelectAll(_unavailableComputers))">@Localizer["SelectAll"]</MudButton>
                            <MudButton Color="Color.Primary" Variant="Variant.Outlined" OnClick="DeselectAllUnavailableComputers" Disabled="@(!CanDeselectAll(_unavailableComputers))">@Localizer["DeselectAll"]</MudButton>
                            <div class="mt-4 flex flex-wrap gap-4">
                                @if (_unavailableComputers.Any())
                                {
                                    @foreach (var computer in GetSortedComputers(_unavailableComputers))
                                    {
                                        <div class="w-1/6">
                                            <ComputerCard @key="computer" Computer="computer" IsSelectedChanged="@(isSelected => SelectComputer(computer, isSelected))" IsSelected="_selectedComputers.Contains(computer)" />
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="w-full p-4 text-center">
                                        <MudText Typo="Typo.body1">@Localizer["NoUnavailableComputers"]</MudText>
                                    </div>
                                }
                            </div>
                        </MudExpansionPanel>
                        <MudExpansionPanel Text="@(Localizer["PendingComputers"] + " (" + _pendingComputers.Count + ")")" Expanded="true">
                            <MudButton Color="Color.Primary" Variant="Variant.Outlined" OnClick="SelectAllPendingComputers" Disabled="@(!CanSelectAll(_pendingComputers))">@Localizer["SelectAll"]</MudButton>
                            <MudButton Color="Color.Primary" Variant="Variant.Outlined" OnClick="DeselectAllPendingComputers" Disabled="@(!CanDeselectAll(_pendingComputers))">@Localizer["DeselectAll"]</MudButton>
                            <div class="mt-4 flex flex-wrap gap-4">
                                @if (_pendingComputers.Any())
                                {
                                    @foreach (var computer in GetSortedComputers(_pendingComputers))
                                    {
                                        <div class="w-1/6">
                                            <ComputerCard @key="computer" Computer="computer" IsSelectedChanged="@(isSelected => SelectComputer(computer, isSelected))" IsSelected="_selectedComputers.Contains(computer)" />
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="w-full p-4 text-center">
                                        <MudText Typo="Typo.body1">@Localizer["NoPendingComputers"]</MudText>
                                    </div>
                                }
                            </div>
                        </MudExpansionPanel>
                    </MudExpansionPanels>
                </div>
            </div>
        </div>
    </MudMainContent>
</MudLayout>

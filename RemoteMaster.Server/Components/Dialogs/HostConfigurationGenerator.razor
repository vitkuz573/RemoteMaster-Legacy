@using Microsoft.AspNetCore.Identity
@using RemoteMaster.Server.Data
@using RemoteMaster.Shared.Abstractions
@using RemoteMaster.Server.Abstractions

@inject NavigationManager NavigationManager
@inject IHostInformationService HostInformationService
@inject IJSRuntime JsRuntime
@inject UserManager<ApplicationUser> UserManager
@inject ApplicationDbContext DbContext
@inject ICountryProvider CountryProvider
@inject HttpClient HttpClient

<MudDialog>
    <DialogContent>
        <EditForm Model="@_model" OnValidSubmit="OnValidSubmit">
            <DataAnnotationsValidator />
            <MudCardContent>
                <MudExpansionPanels>
                    <MudExpansionPanel Text="Main Parameters">
                        <MudTextField Label="Server" @bind-Value="_model.Server" For="@(() => _model.Server)" ReadOnly="true" />
                    </MudExpansionPanel>

                    <MudExpansionPanel Text="Subject Parameters">
                        <MudSelect Label="Organization" Value="_selectedOrganization" T="string" ValueChanged="OrganizationChanged" Dense>
                            @foreach (var organization in _organizations)
                            {
                                <MudSelectItem Value="@organization.Name">@organization.Name</MudSelectItem>
                            }
                        </MudSelect>
                        <MudSelect Label="Organizational Unit" Value="_selectedOrganizationalUnit" T="string" ValueChanged="OrganizationalUnitChanged" Dense Disabled="@string.IsNullOrEmpty(_selectedOrganization)">
                            @foreach (var unit in _organizationalUnits)
                            {
                                <MudSelectItem Value="@unit.Name">@unit.Name</MudSelectItem>
                            }
                        </MudSelect>
                        <MudTextField Label="Locality" @bind-Value="_model.Subject.Locality" For="@(() => _model.Subject.Locality)" ReadOnly="true" />
                        <MudTextField Label="State" @bind-Value="_model.Subject.State" For="@(() => _model.Subject.State)" ReadOnly="true" />
                        <MudSelect T="string" Label="Country" @bind-Value="_model.Subject.Country" Dense="true" ReadOnly="true">
                            @foreach (var country in _countries)
                            {
                                <MudSelectItem T="string" Value="@country.Code">@country.Name</MudSelectItem>
                            }
                        </MudSelect>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            </MudCardContent>

            <MudCardActions>
                <MudButton ButtonType="ButtonType.Submit" Color="Color.Primary">Download Configuration</MudButton>
                <MudButton Color="Color.Secondary" OnClick="DownloadHost">Download Host</MudButton>
            </MudCardActions>
        </EditForm>
    </DialogContent>
</MudDialog>